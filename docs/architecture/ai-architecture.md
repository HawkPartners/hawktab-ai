## Architecture (Machine-Oriented)

Objective: Fast onboarding for AI agents. Contracts, paths, invariants.

### Core contracts
- CutsSpec: `{ cuts: [{ id, name, rExpression }] }` where `id = groupSlug.nameSlug`.
- TablePlan: `{ tables: [{ id, title, questionVar(s), tableType, nets?, base?, filters?, notes? }] }`.
- RScriptJob: `{ dataFilePath, dataMapAgent, tablePlan, cutsSpec }`.

### Outputs by path
- Session root: `temp-outputs/output-<ts>/`
- Inputs snapshot: `inputs.json`
- Banner: `banner-bannerPlan-*.json`
- Data map: `dataMap-*.json`
- Crosstab: `crosstab-output-*.json`
- Validation: `validation-status.json`
- R: `r/manifest.json`, `r/scripts/*.R`, `r/master.R`
- Results: `results/*.csv`, `workbook.xlsx`

### APIs (see also api.md)
- `POST /api/process-crosstab` → orchestrates end-to-end processing
- `GET /api/process-crosstab/status` → status
- `POST /api/generate-r/[sessionId]` → create/execute R
- `GET/POST /api/validate/[sessionId]` → validation read/write
- `GET /api/validation-queue` → list sessions
- `DELETE /api/delete-session/[sessionId]` → cleanup

### Invariants
- Total column exists and uses letter `T` in significance lettering.
- Cuts in R must match validated `adjusted` expressions.
- SPSS read via R (`haven::read_sav`); analytics in R; Excel composed in Node.

### Key code locations
- Agents: `src/agents/*.ts`
- Prompts: `src/prompts/**`
- Processors: `src/lib/processors/*.ts`
- Storage and job handling: `src/lib/storage.ts`, `src/lib/jobStore.ts`
- Exporters and tables: `src/lib/exporters/**`, `src/lib/tables/**`
- Schemas: `src/schemas/**`

### Environment and model config
- Environment helper: `src/lib/env.ts`
  - `OPENAI_API_KEY` required (must start with `sk-`)
  - `NODE_ENV` influences model selection and dev outputs
  - Prompt flags: `CROSSTAB_PROMPT_VERSION`, `BANNER_PROMPT_VERSION`
  - Token/limit flags: `REASONING_MODEL_TOKENS`, `BASE_MODEL_TOKENS`
  - Tracing flag: `OPENAI_AGENTS_DISABLE_TRACING`
  - Model selection: development uses `reasoningModel`, production uses `baseModel`

### Session organization and storage
- Uploads initially saved under OS temp dir via `src/lib/storage.ts` (session id: `session-<ts>-<rand>`)
- Processing writes canonical artifacts under `temp-outputs/output-<ISO-ts>/` (stable for browsing)
- SPSS file is copied as `dataFile.sav` into the session folder for R

### Canonical JSON shapes
- `validation-status.json` (persisted by process and validation routes):
```json
{
  "sessionId": "output-2025-08-08T14-53-39-903Z",
  "status": "pending",
  "createdAt": "2025-08-08T14:54:00.000Z",
  "validatedAt": "2025-08-08T15:10:00.000Z"
}
```

- Cut Table JSON (generated by generate-tables route):
```json
{
  "sessionId": "output-...",
  "generatedAt": "2025-08-08T...Z",
  "groups": [
    {
      "groupName": "Role",
      "columns": [ { "name": "Physician", "expression": "...", "confidence": 0.92, "reason": "..." } ]
    }
  ],
  "stats": { "groupCount": 6, "columnCount": 19, "averageConfidence": 0.87 }
}
```

- R Manifest (target):
```json
{
  "dataFilePath": "temp-outputs/output-.../dataFile.sav",
  "tablePlan": { "tables": [ { "id": "q1", "title": "Q1", "tableType": "single" } ] },
  "cutsSpec": { "cuts": [ { "id": "role.physician", "name": "Physician", "rExpression": "..." } ] }
}
```

### Orchestration specifics
- `POST /api/process-crosstab`:
  - Validates env; saves uploaded files; runs BannerAgent → DataMapProcessor → CrosstabAgent
  - Writes `inputs.json`, copies `dataFile.sav`, and scaffolds `validation-status.json`
  - Returns `{ accepted, jobId, sessionId }` immediately and processes in background

### Trace behavior
- Use `withTrace()` for group-by-group validation; force flush via `getGlobalTraceProvider().forceFlush()`
- Traces visible on `https://platform.openai.com/traces` when enabled


