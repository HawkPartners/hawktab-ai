# Bug Tracker - Run 2026-01-03T12-28-45-200Z

**Dataset**: leqvio-demand-data
**Created**: 2026-01-03T12:31:02.951Z
**Status**: Pending Review

---

## How to Use This File

1. Review the output files in this folder
2. Document any bugs found using the template below
3. Update the Summary table as you go
4. Mark status as "Reviewed" when complete

---

## Quick Add Template

Copy this template for each bug found:

```markdown
### Bug X: [Short description]

**Category**: [Data Map | Banner | Crosstab | R Script | Other]
**Severity**: [Critical | High | Medium | Low]
**Affected**: [File or variable names]

**Current behavior**:
[What happened]

**Expected behavior**:
[What should happen]

**Root cause** (if known):
[Why it happened]

**Status**: [ ] Not Fixed  [ ] Fixed  [ ] Won't Fix
```

---

## Data Map Bugs

<!-- Add Data Map related bugs here -->

---

## Banner Plan Bugs

<!-- Add Banner Plan related bugs here -->

---

## Crosstab/Validation Bugs

### Bug 1: CrosstabAgent ignores BannerAgent's filter structure for Segments

**Category**: Crosstab
**Severity**: Medium
**Affected**: Segments group (Segment A, B, C, D)

**Current behavior**:
- BannerAgent correctly outputs: `"original": "Segment=Segment A"`
- CrosstabAgent ignores this and assumes A=1, B=2, C=3, D=4
- Produces: `Segment == 1` (wrong - numeric comparison)
- Scratchpad shows: "No documented Answer_Options for this variable. Assuming labels A, B, C, D map to codes 1, 2, 3, 4"

**Expected behavior**:
- CrosstabAgent should recognize that `Segment=Segment A` already looks like a valid filter
- Should produce: `Segment == "Segment A"` (string comparison)
- The BannerAgent's structure should take priority when it's already in filter-like format

**Root cause**:
CrosstabAgent prompt doesn't prioritize the `original` expression when it already contains a value. It falls back to inferring A=1, B=2 even when the actual value ("Segment A") is provided.

**Proposed fix**:
Update CrosstabAgent prompt to:
1. Check if `original` expression already contains a specific value (e.g., `Segment=Segment A`)
2. If so, convert directly to R syntax: `Segment == "Segment A"`
3. Only infer numeric mapping (A=1, B=2) when the value is NOT specified in the original

**Status**: [ ] Not Fixed  [ ] Documented  [x] Fixed  [ ] Won't Fix

**Fix Applied** (January 3, 2026):
- Added TYPE 3: EXPLICIT VALUE EXPRESSIONS to `src/prompts/crosstab/alternative.ts`
- Added string equality syntax rule: `Segment=Segment A → Segment == "Segment A"`
- Key principle: Trust explicit values from BannerAgent; only infer numeric codes when values are ambiguous

---

## R Script Bugs

### Bug 2: Sub-level numeric range variables showing frequency instead of mean-only

**Category**: R Script
**Severity**: Medium
**Affected**: S8r1, S8r2, S8r3, S8r4 (and any similar sub-level numeric range variables)

**Current behavior**:
- Sub-variables like S8r1 (0-100 percent allocation) are being treated with smart bucketing
- Shows frequency distribution with buckets instead of just the mean
- This is wrong for "percentage of time" style questions where rows should show mean values

**Expected behavior**:
- Sub-level numeric range variables should show **mean only** (one row per sub-variable)
- Joe's output shows: "Treating/Managing patients" = 95.2, 94.3, 97.8, etc. (just means per cut)
- The table should be a summary table with each sub-variable as a row, mean as the value

**Key distinction**:
- `level: "parent"` + `normalizedType: "numeric_range"` → smart bucketing (S6 years in practice)
- `level: "sub"` + `normalizedType: "numeric_range"` → mean only (S8r1, S8r2, etc.)

**Root cause**:
RScriptGenerator doesn't differentiate between parent-level and sub-level numeric ranges. The smart bucketing logic applies to all numeric_range types regardless of their level in the question hierarchy.

**Proposed fix**:
Modify `generateMultiSubTable()` in `src/lib/r/RScriptGenerator.ts`:

1. Check if `table.normalizedType === 'numeric_range'`
2. If true, generate mean calculation instead of frequency count:
   ```r
   # Instead of: count <- sum(cut_data$`S8r1` == 1, na.rm = TRUE)
   # Generate:   mean_val <- round_half_up(mean(cut_data$`S8r1`, na.rm = TRUE), 1)
   ```
3. Output format should be just the mean value (e.g., "95.2") not "X% (N)"

**Files to modify**:
- `src/lib/r/RScriptGenerator.ts` - `generateMultiSubTable()` function (~line 324)

**Status**: [ ] Not Fixed  [x] Documented  [ ] Fixed  [ ] Won't Fix

---

### Bug 3: Sub-level categorical questions only showing one answer option value

**Category**: R Script / TablePlan
**Severity**: High
**Affected**: A1 (and similar multi-row categorical questions like A6)

**Current behavior**:
- A1 has sub-questions (A1r1=Leqvio, A1r2=Praluent, A1r3=Repatha)
- Each sub-question has categorical values (1-2 representing different indications)
- We're only showing answer option 1, completely missing answer option 2
- Output shows one table with incomplete data

**Expected behavior**:
- Should show ALL answer option values, not just the first one
- Joe provides two formats:
  1. **Merged table**: Treatments as rows, each answer option as indented sub-row
  2. **Separate tables**: One table per answer option value (Table #2 for option 1, Table #3 for option 2)

**Data map indicators**:
- `level: "sub"` + `normalizedType: "categorical_select"` + `allowedValues: [1, 2, ...]`
- Need to iterate through ALL allowedValues, not just first one

**Root cause**:
TablePlan/RScriptGenerator only generates one table for sub-question groups, showing frequency for a single value instead of iterating through all categorical options.

**Proposed fix**:
Generate **separate tables per answer option value** in R. Merging into a nested view will be handled later by ExcelJS.

**Step 1: Modify TablePlan.ts** (`src/lib/tables/TablePlan.ts`):
When building multi_subs tables where `normalizedType === 'categorical_select'` and items have `allowedValues.length > 1`:

```typescript
// Instead of creating ONE table for the group:
// Create MULTIPLE tables, one per allowedValue

// Example: A1 with allowedValues [1, 2] becomes:
// - Table "a1-value-1" with title "A1: [question text] - Value 1"
// - Table "a1-value-2" with title "A1: [question text] - Value 2"
```

Add a new property to track which value this table represents:
```typescript
export type MultiSubTableDefinition = {
  // ... existing fields
  targetValue?: number | string;  // NEW: which allowedValue this table counts
};
```

**Step 2: Modify RScriptGenerator.ts** (`src/lib/r/RScriptGenerator.ts`):
In `generateMultiSubTable()`, use `table.targetValue` if present:

```r
# Current (hardcoded positiveValue):
count <- sum(cut_data$`A1r1` == 1, na.rm = TRUE)

# Fixed (use table.targetValue):
count <- sum(cut_data$`A1r1` == ${table.targetValue}, na.rm = TRUE)
```

**Files to modify**:
- `src/lib/tables/TablePlan.ts` - modify `buildTablePlanFromDataMap()` to create separate tables per value
- `src/lib/r/RScriptGenerator.ts` - use `targetValue` in `generateMultiSubTable()`

**Status**: [ ] Not Fixed  [x] Documented  [ ] Fixed  [ ] Won't Fix

---

### Bug 4: Column variables (c1, c2) need separate table handling

**Category**: TablePlan / R Script
**Severity**: Medium
**Affected**: A3a (A3ar1c1, A3ar1c2, etc.) and similar column-structured questions

**Current behavior**:
- System IS correctly grouping c1 and c2 variables together (partially working)
- However, treatment name (Leqvio, Praluent) is in `context`, not `description`
- Description only shows "In addition to statin" / "Without a statin"
- Output format unclear about what treatment is being discussed
- All row groups (r1, r2, r3...) lumped into one giant table with repeated labels

**Pattern to detect**:
- Variable naming: `A3ar1c1`, `A3ar1c2` (has row `r1` + column `c1`, `c2` suffix)
- The `context` field contains the treatment/grouping info
- Example: `"context": "A3ar1: Leqvio (inclisiran) - For each treatment..."`

**Root cause**:
TablePlan groups all sub-variables by `parentQuestion` (A3a), but column-structured variables need to be grouped by **row** (A3ar1, A3ar2, etc.) instead.

**Proposed fix**:
Detect `r\d+c\d+` pattern in TablePlan and group by row instead of by parent.

**Step 1: Modify TablePlan.ts** (`src/lib/tables/TablePlan.ts`):
Before creating multi_subs tables, detect column-structured variables and regroup:

```typescript
// Detect pattern: variable ends with r\d+c\d+
const columnVarPattern = /^(.+r\d+)(c\d+)$/;

// When processing subGroups, check if variables match column pattern
// If so, group by ROW instead of by parentQuestion:
// - A3ar1c1, A3ar1c2 → group "A3ar1" (Leqvio)
// - A3ar2c1, A3ar2c2 → group "A3ar2" (Praluent)
// - A3ar3c1, A3ar3c2 → group "A3ar3" (Repatha)

// For each row group:
// - Use context as table title (contains treatment name)
// - Column variables (c1, c2) become rows in the table
```

**Step 2: Extract row group from context**:
The `context` field already contains the row-specific info:
```
"context": "A3ar1: Leqvio (inclisiran) - For each treatment..."
```
Parse this to get "Leqvio (inclisiran)" as the table title.

**Implementation details**:
```typescript
// In buildTablePlanFromDataMap(), after grouping subs by parentQuestion:

for (const [parentQ, groupItems] of subGroups) {
  // Check if ANY item matches column pattern
  const hasColumnStructure = groupItems.some(item =>
    columnVarPattern.test(item.column)
  );

  if (hasColumnStructure) {
    // Regroup by row (e.g., A3ar1, A3ar2, A3ar3)
    const rowGroups = new Map<string, VerboseDataMapType[]>();
    for (const item of groupItems) {
      const match = item.column.match(columnVarPattern);
      if (match) {
        const rowKey = match[1]; // "A3ar1", "A3ar2", etc.
        if (!rowGroups.has(rowKey)) rowGroups.set(rowKey, []);
        rowGroups.get(rowKey)!.push(item);
      }
    }

    // Create separate table for each row group
    for (const [rowKey, rowItems] of rowGroups) {
      // Use first item's context for title (all items in row share context)
      const title = rowItems[0].context || rowKey;
      // Create table with rowItems...
    }
  } else {
    // Current behavior for non-column variables
  }
}
```

**Relationship to other bugs**:
- **Bug 2**: These column variables are often `numeric_range` → should show mean only (Bug 2 fix applies)
- **Bug 3**: Similar pattern of splitting tables, but based on variable structure not allowedValues

**Files to modify**:
- `src/lib/tables/TablePlan.ts` - add column-structure detection and row-based grouping

**Status**: [ ] Not Fixed  [x] Documented  [ ] Fixed  [ ] Won't Fix

---

## Other Issues

<!-- Add any other issues here -->

---

## Notes / Items to Revisit

### Note 1: S11 Mean/Median discrepancy with Joe's tabs

**Variable**: S11 (Number of patients with hypercholesterolemia and CVD)

**Observation**:
- Our output: Mean = 168.0, Median = 125
- Joe's tabs: Mean = 175.9, Median = 150.0

**Investigation**:
- Verified our code is calculating correctly from the SPSS data
- Raw data confirms: 180 rows, no NA values, no zeros, all values >= 10
- Our calculations match the raw SPSS file exactly

**Likely cause**:
- Different data file version (Joe may have used W2 or W3, not practice file)
- Weighting applied in Joe's processing that we're not replicating
- Cannot fully confirm without knowing exact data source Joe used

**Action**: Flag for later review when comparing against final reports. Not a code bug.

---

## Summary

| Bug | Category | Severity | Status | Description |
|-----|----------|----------|--------|-------------|
| 1 | Crosstab | Medium | **Fixed** | CrosstabAgent ignores BannerAgent's filter structure for Segments - assumes A=1,B=2 instead of using "Segment A" string |
| 2 | R Script | Medium | **Ready to Implement** | Sub-level numeric ranges (S8r1-r4) showing buckets instead of mean-only → Fix: modify `generateMultiSubTable()` to output mean |
| 3 | R Script / TablePlan | High | **Ready to Implement** | Sub-level categorical (A1, A6) only showing first answer option → Fix: create separate tables per allowedValue |
| 4 | TablePlan / R Script | Medium | **Ready to Implement** | Column variables (A3ar1c1, c2) lumped together → Fix: detect `r\d+c\d+` pattern, group by row, use context for title |

---

## Review Notes

**Reviewer**:
**Review Date**:
**Overall Assessment**:

---

*Generated by HawkTab AI - 2026-01-03T12-28-45-200Z*
